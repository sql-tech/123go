<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>```html
<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
</script>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>123go形象網站設計報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/docx-js@1.0.1/dist/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sanitize-html/2.13.0/sanitize-html.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #E5E7EB, #D1D5DB);
            font-family: 'Noto Sans TC', sans-serif;
        }
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0;
        }
        .header {
            background: #2563EB;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .card {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-4px);
        }
        .card h2 {
            font-size: 1.5rem;
            color: #4A4A4A;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            color: #4A4A4A;
            margin-bottom: 8px;
        }
        input[type="password"], input[type="text"], input[type="email"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            transition: border-color 0.2s ease;
        }
        input[type="password"]:focus, input[type="text"]:focus, input[type="email"]:focus, textarea:focus, select:focus {
            border-color: #2563EB;
            outline: none;
        }
        select {
            max-width: 200px;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .error {
            color: #EF4444;
            display: none;
            margin-top: 8px;
            font-size: 0.9rem;
            transition: opacity 0.2s ease;
            opacity: 0;
        }
        .error.show {
            display: block;
            opacity: 1;
        }
        .btn {
            display: block;
            width: 200px;
            margin: 30px auto 0;
            padding: 12px;
            background: #2563EB;
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            text-align: center;
        }
        .btn:hover {
            background: #3B82F6;
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn:disabled {
            background: #6B7280;
            cursor: not-allowed;
        }
        input.disabled, textarea.disabled {
            background: #E5E7EB;
            cursor: not-allowed;
            color: #4A4A4A;
        }
        #countdown-timer {
            background: #DBEAFE;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1F2937;
        }
        #quote-preview {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        #quote-preview img {
            max-width: 150px;
            margin-bottom: 10px;
        }
        @media (max-width: 768px) {
            .container {
                margin: 20px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .card {
                padding: 15px;
            }
            .card h2 {
                font-size: 1.2rem;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>123go形象網站設計報價系統</h1>
        </div>
        <div class="content">
            <!-- 倒數計時器 -->
            <div id="countdown-timer" class="hidden text-center text-lg font-semibold text-gray-700 bg-blue-100 p-4 rounded-lg mb-4 shadow"></div>
            <!-- 認證 -->
            <div class="card">
                <h2>認證設置</h2>
                <div class="input-group">
                    <label for="pat">Personal Access Token</label>
                    <input type="password" id="pat" placeholder="輸入您的 PAT">
                    <p id="pat-error" class="error">請輸入有效的 PAT！</p>
                </div>
                <button id="auth-btn" class="btn">驗證</button>
            </div>
            <!-- 報價單生成 -->
            <div id="quoteSection" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 客戶資訊 -->
                <div class="card col-span-1 md:col-span-2">
                    <h2>客戶資訊</h2>
                    <div class="input-group">
                        <label for="clientName">客戶名稱</label>
                        <input type="text" id="clientName" placeholder="輸入客戶名稱">
                    </div>
                    <div class="input-group">
                        <label for="clientContact">客戶電話/Line</label>
                        <input type="text" id="clientContact" placeholder="輸入電話或Line ID">
                    </div>
                    <div class="input-group">
                        <label for="clientEmail">客戶 E-mail</label>
                        <input type="email" id="clientEmail" placeholder="輸入E-mail">
                    </div>
                    <div class="input-group">
                        <label for="clientNotes">附註</label>
                        <textarea id="clientNotes" placeholder="輸入附註"></textarea>
                    </div>
                </div>
                <!-- 前端設計 -->
                <div class="card">
                    <h2>前端設計</h2>
                    <div class="input-group">
                        <label for="frontendLevel">選擇服務層級</label>
                        <select id="frontendLevel">
                            <option value="none">不選擇</option>
                            <option value="basic">基礎 ($10,000)</option>
                            <option value="advanced">進階 ($20,000)</option>
                            <option value="premium">高階 ($30,000)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="frontendNotes">自訂功能描述</label>
                        <input type="text" id="frontendNotes" placeholder="輸入自訂功能（例如：留言板、寄信模組）">
                    </div>
                </div>
                <!-- 後端開發 -->
                <div class="card">
                    <h2>後端開發</h2>
                    <div class="input-group">
                        <label for="backendLevel">選擇服務層級</label>
                        <select id="backendLevel">
                            <option value="none">不選擇</option>
                            <option value="basic">基礎 ($8,000)</option>
                            <option value="advanced">進階 ($15,000)</option>
                            <option value="premium">高階 ($25,000)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="backendNotes">自訂功能描述</label>
                        <input type="text" id="backendNotes" placeholder="輸入自訂功能（例如：資料庫管理、API整合）">
                    </div>
                </div>
                <!-- SEO -->
                <div class="card">
                    <h2>SEO</h2>
                    <div class="input-group">
                        <label for="seoLevel">選擇服務層級</label>
                        <select id="seoLevel">
                            <option value="none">不選擇</option>
                            <option value="basic">基礎 ($5,000)</option>
                            <option value="advanced">進階 ($10,000)</option>
                            <option value="premium">高階 ($20,000)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="seoNotes">自訂功能描述</label>
                        <input type="text" id="seoNotes" placeholder="輸入自訂功能（例如：關鍵字優化、內容行銷）">
                    </div>
                </div>
                <!-- 主機代管 -->
                <div class="card">
                    <h2>主機代管</h2>
                    <div class="input-group">
                        <label for="hostingLevel">選擇服務層級</label>
                        <select id="hostingLevel">
                            <option value="none">不選擇</option>
                            <option value="basic">基礎 ($500/年)</option>
                            <option value="advanced">進階 ($1,500/年)</option>
                            <option value="premium">高階 ($3,000/年)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="hostingNotes">自訂功能描述</label>
                        <input type="text" id="hostingNotes" placeholder="輸入自訂功能（例如：雲端備份、SSL證書）">
                    </div>
                </div>
                <!-- 後續維護 -->
                <div class="card">
                    <h2>後續維護</h2>
                    <div class="input-group">
                        <label for="maintenanceLevel">選擇服務層級</label>
                        <select id="maintenanceLevel">
                            <option value="none">不選擇</option>
                            <option value="basic">基礎 ($1,000/月)</option>
                            <option value="advanced">進階 ($2,500/月)</option>
                            <option value="premium">高階 ($5,000/月)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="maintenanceNotes">自訂功能描述</label>
                        <input type="text" id="maintenanceNotes" placeholder="輸入自訂功能（例如：定期更新、技術支援）">
                    </div>
                </div>
                <!-- 折扣 -->
                <div class="card">
                    <h2>折扣</h2>
                    <div class="input-group">
                        <label for="discount">選擇折扣</label>
                        <select id="discount">
                            <option value="none">無折扣</option>
                            <option value="full">全包折扣 (10%)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="discountNotes">自訂功能描述</label>
                        <input type="text" id="discountNotes" placeholder="輸入自訂功能（例如：促銷活動、長期合作）">
                    </div>
                </div>
                <!-- 補充說明 -->
                <div class="card col-span-1 md:col-span-2">
                    <h2>補充說明</h2>
                    <div class="input-group">
                        <label for="additionalNotes">補充說明</label>
                        <textarea id="additionalNotes" placeholder="輸入補充說明"></textarea>
                    </div>
                    <button id="confirm-notes-btn" class="btn">確定帶入報價單</button>
                </div>
                <!-- 報價預覽 -->
                <div id="quote-preview" class="card col-span-1 md:col-span-2">
                    <img src="/img/logo.jpg" alt="123go Logo">
                    <h2>123go形象網站設計報價單</h2>
                    <p id="order-number">報價單編號：載入中...</p>
                    <p>日期：<span id="quote-date"></span> | 有效期限：<span id="quote-expiry"></span></p>
                    <div class="mt-4">
                        <p><strong>客戶名稱：</strong> <span id="preview-clientName">未輸入</span></p>
                        <p><strong>客戶電話/Line：</strong> <span id="preview-clientContact">未輸入</span></p>
                        <p><strong>客戶 E-mail：</strong> <span id="preview-clientEmail">未輸入</span></p>
                        <p><strong>附註：</strong> <span id="preview-clientNotes">未輸入</span></p>
                    </div>
                    <table class="w-full border-collapse mt-4">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border p-2">服務項目</th>
                                <th class="border p-2">層級</th>
                                <th class="border p-2">費用 (NTD)</th>
                            </tr>
                        </thead>
                        <tbody id="quote-table-body"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2" class="border p-2 text-right font-semibold">小計</td>
                                <td id="subtotal" class="border p-2">0</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="border p-2 text-right font-semibold">折扣</td>
                                <td id="discount-amount" class="border p-2">0</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="border p-2 text-right font-semibold">營業稅 (5%)</td>
                                <td id="tax" class="border p-2">0</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="border p-2 text-right font-semibold">總計</td>
                                <td id="total" class="border p-2">0</td>
                            </tr>
                        </tfoot>
                    </table>
                    <p class="mt-4">付款條款：30% 訂金，50% 初稿完成後，20% 上線後。</p>
                    <p>備註：包含 2 次免費修改，額外修改每次 500 元。專案預計 6 週完成。</p>
                    <p><strong>補充說明：</strong> <span id="preview-additionalNotes">未輸入</span></p>
                </div>
                <!-- 產生報價單按鈕 -->
                <button id="generate-quote-btn" class="btn">產生報價單</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化元素
            const patInput = document.getElementById('pat');
            const authBtn = document.getElementById('auth-btn');
            const countdownTimer = document.getElementById('countdown-timer');
            const quoteSection = document.getElementById('quoteSection');
            const patError = document.getElementById('pat-error');
            const clientName = document.getElementById('clientName');
            const clientContact = document.getElementById('clientContact');
            const clientEmail = document.getElementById('clientEmail');
            const clientNotes = document.getElementById('clientNotes');
            const additionalNotes = document.getElementById('additionalNotes');
            const confirmNotesBtn = document.getElementById('confirm-notes-btn');
            const frontendLevel = document.getElementById('frontendLevel');
            const backendLevel = document.getElementById('backendLevel');
            const seoLevel = document.getElementById('seoLevel');
            const hostingLevel = document.getElementById('hostingLevel');
            const maintenanceLevel = document.getElementById('maintenanceLevel');
            const discountSelect = document.getElementById('discount');
            const frontendNotes = document.getElementById('frontendNotes');
            const backendNotes = document.getElementById('backendNotes');
            const seoNotes = document.getElementById('seoNotes');
            const hostingNotes = document.getElementById('hostingNotes');
            const maintenanceNotes = document.getElementById('maintenanceNotes');
            const discountNotes = document.getElementById('discountNotes');
            const quoteTableBody = document.getElementById('quote-table-body');
            const subtotalEl = document.getElementById('subtotal');
            const discountAmountEl = document.getElementById('discount-amount');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');
            const orderNumberEl = document.getElementById('order-number');
            const quoteDateEl = document.getElementById('quote-date');
            const quoteExpiryEl = document.getElementById('quote-expiry');
            const previewClientName = document.getElementById('preview-clientName');
            const previewClientContact = document.getElementById('preview-clientContact');
            const previewClientEmail = document.getElementById('preview-clientEmail');
            const previewClientNotes = document.getElementById('preview-clientNotes');
            const previewAdditionalNotes = document.getElementById('preview-additionalNotes');
            const generateQuoteBtn = document.getElementById('generate-quote-btn');

            // 價格表
            const prices = {
                frontend: { basic: 10000, advanced: 20000, premium: 30000 },
                backend: { basic: 8000, advanced: 15000, premium: 25000 },
                seo: { basic: 5000, advanced: 10000, premium: 20000 },
                hosting: { basic: 500, advanced: 1500, premium: 3000 },
                maintenance: { basic: 1000, advanced: 2500, premium: 5000 }
            };

            // 清理輸入以防止 XSS
            function sanitizeInput(input) {
                if (typeof sanitizeHtml === 'function') {
                    return sanitizeHtml(input, {
                        allowedTags: [],
                        allowedAttributes: {}
                    });
                } else {
                    console.warn('sanitizeHtml 未定義，使用基本清理');
                    return input.replace(/[<>&"']/g, ''); // 簡單清理 HTML 特殊字符
                }
            }

            // 獲取訂單編號
            async function getOrderNumber() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                try {
                    const response = await fetch('/jim/quote/get-order-number', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ year, month })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const sequence = parseInt(data.sequence) || 0;
                        return `${year}-${month}-${String(sequence + 1).padStart(3, '0')}`;
                    } else {
                        throw new Error(`獲取訂單編號失敗：${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('獲取訂單編號錯誤:', error);
                    return `${year}-${month}-001`; // 後備編號
                }
            }

            // 更新訂單序號
            async function updateOrderNumber() {
                try {
                    const response = await fetch('/jim/quote/update-order-number', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (!response.ok) {
                        throw new Error(`更新訂單序號失敗：${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('更新訂單序號錯誤:', error);
                    alert('更新訂單序號失敗，請聯繫管理員！');
                }
            }

            // 儲存所有資料到 jim/quote/temp.txt 或 localStorage
            async function saveQuoteData() {
                try {
                    const quoteData = {
                        clientName: sanitizeInput(clientName.value),
                        clientContact: sanitizeInput(clientContact.value),
                        clientEmail: sanitizeInput(clientEmail.value),
                        clientNotes: sanitizeInput(clientNotes.value),
                        additionalNotes: sanitizeInput(additionalNotes.value),
                        services: [
                            { name: '前端設計', level: frontendLevel.value, price: prices.frontend[frontendLevel.value] || 0, notes: sanitizeInput(frontendNotes.value) },
                            { name: '後端開發', level: backendLevel.value, price: prices.backend[backendLevel.value] || 0, notes: sanitizeInput(backendNotes.value) },
                            { name: 'SEO', level: seoLevel.value, price: prices.seo[seoLevel.value] || 0, notes: sanitizeInput(seoNotes.value) },
                            { name: '主機代管', level: hostingLevel.value, price: prices.hosting[hostingLevel.value] || 0, notes: sanitizeInput(hostingNotes.value) },
                            { name: '後續維護', level: maintenanceLevel.value, price: prices.maintenance[maintenanceLevel.value] || 0, notes: sanitizeInput(maintenanceNotes.value) },
                            { name: '折扣', level: discountSelect.value, price: 0, notes: sanitizeInput(discountNotes.value) }
                        ]
                    };
                    try {
                        const response = await fetch('/jim/quote/save-temp', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(quoteData)
                        });
                        if (response.ok) {
                            console.log('報價單資料已儲存至 jim/quote/temp.txt');
                            updateQuotePreview();
                            return;
                        } else {
                            throw new Error(`儲存失敗：${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.warn('後端儲存失敗，改用 localStorage:', error);
                    }
                    localStorage.setItem('quoteData', JSON.stringify(quoteData));
                    console.log('報價單資料已儲存至 localStorage');
                    updateQuotePreview();
                } catch (error) {
                    console.error('儲存報價單資料錯誤:', error);
                    alert(`儲存報價單資料失敗：${error.message}`);
                }
            }

            // 從 jim/quote/temp.txt 或 localStorage 讀取報價單資料
            async function fetchQuoteData() {
                try {
                    const response = await fetch('/jim/quote/read-temp', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return data || {
                            clientName: '未輸入',
                            clientContact: '未輸入',
                            clientEmail: '未輸入',
                            clientNotes: '未輸入',
                            additionalNotes: '未輸入',
                            services: [
                                { name: '前端設計', level: 'none', price: 0, notes: '' },
                                { name: '後端開發', level: 'none', price: 0, notes: '' },
                                { name: 'SEO', level: 'none', price: 0, notes: '' },
                                { name: '主機代管', level: 'none', price: 0, notes: '' },
                                { name: '後續維護', level: 'none', price: 0, notes: '' },
                                { name: '折扣', level: 'none', price: 0, notes: '' }
                            ]
                        };
                    } else {
                        throw new Error(`讀取失敗：${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn('後端讀取失敗，改用 localStorage:', error);
                    try {
                        const data = JSON.parse(localStorage.getItem('quoteData') || '{}');
                        return data || {
                            clientName: '未輸入',
                            clientContact: '未輸入',
                            clientEmail: '未輸入',
                            clientNotes: '未輸入',
                            additionalNotes: '未輸入',
                            services: [
                                { name: '前端設計', level: 'none', price: 0, notes: '' },
                                { name: '後端開發', level: 'none', price: 0, notes: '' },
                                { name: 'SEO', level: 'none', price: 0, notes: '' },
                                { name: '主機代管', level: 'none', price: 0, notes: '' },
                                { name: '後續維護', level: 'none', price: 0, notes: '' },
                                { name: '折扣', level: 'none', price: 0, notes: '' }
                            ]
                        };
                    } catch {
                        return {
                            clientName: '未輸入',
                            clientContact: '未輸入',
                            clientEmail: '未輸入',
                            clientNotes: '未輸入',
                            additionalNotes: '未輸入',
                            services: [
                                { name: '前端設計', level: 'none', price: 0, notes: '' },
                                { name: '後端開發', level: 'none', price: 0, notes: '' },
                                { name: 'SEO', level: 'none', price: 0, notes: '' },
                                { name: '主機代管', level: 'none', price: 0, notes: '' },
                                { name: '後續維護', level: 'none', price: 0, notes: '' },
                                { name: '折扣', level: 'none', price: 0, notes: '' }
                            ]
                        };
                    }
                }
            }

            // 重置畫面
            function resetForm() {
                clientName.value = '';
                clientContact.value = '';
                clientEmail.value = '';
                clientNotes.value = '';
                additionalNotes.value = '';
                frontendLevel.value = 'none';
                backendLevel.value = 'none';
                seoLevel.value = 'none';
                hostingLevel.value = 'none';
                maintenanceLevel.value = 'none';
                discountSelect.value = 'none';
                frontendNotes.value = '';
                backendNotes.value = '';
                seoNotes.value = '';
                hostingNotes.value = '';
                maintenanceNotes.value = '';
                discountNotes.value = '';
                updateQuotePreview();
            }

            // 更新報價預覽
            async function updateQuotePreview() {
                const today = new Date();
                const expiry = new Date(today);
                expiry.setDate(today.getDate() + 30);

                // 更新訂單編號與日期
                const orderNumber = await getOrderNumber();
                orderNumberEl.textContent = `報價單編號：${orderNumber}`;
                quoteDateEl.textContent = today.toLocaleDateString('zh-TW');
                quoteExpiryEl.textContent = expiry.toLocaleDateString('zh-TW');

                // 從 temp.txt 或 localStorage 讀取報價單資料
                const quoteData = await fetchQuoteData();

                // 更新客戶資訊
                previewClientName.textContent = quoteData.clientName;
                previewClientContact.textContent = quoteData.clientContact;
                previewClientEmail.textContent = quoteData.clientEmail;
                previewClientNotes.textContent = quoteData.clientNotes;
                previewAdditionalNotes.textContent = quoteData.additionalNotes;

                // 更新服務項目
                const selectedServices = quoteData.services;

                // 更新表格
                quoteTableBody.innerHTML = '';
                let subtotal = 0;
                selectedServices.forEach(service => {
                    if (service.level !== 'none') {
                        if (service.name !== '折扣') {
                            subtotal += service.price;
                        }
                        const row = document.createElement('tr');
                        const displayName = service.notes ? `${service.name}（${service.notes}）` : service.name;
                        row.innerHTML = `
                            <td class="border p-2">${displayName}</td>
                            <td class="border p-2">${service.level === 'basic' ? '基礎' : service.level === 'advanced' ? '進階' : service.level === 'premium' ? '高階' : service.level === 'full' ? '全包折扣' : '無'}</td>
                            <td class="border p-2">${service.price.toLocaleString()}</td>
                        `;
                        quoteTableBody.appendChild(row);
                    }
                });

                // 計算折扣與稅金
                let discount = 0;
                const hasAllServices = selectedServices.slice(0, 5).every(s => s.level !== 'none');
                if (selectedServices.find(s => s.name === '折扣').level === 'full' && hasAllServices) {
                    discount = subtotal * 0.1;
                }
                const tax = (subtotal - discount) * 0.05;
                const total = subtotal - discount + tax;

                // 更新顯示
                subtotalEl.textContent = subtotal.toLocaleString();
                discountAmountEl.textContent = discount.toLocaleString();
                taxEl.textContent = tax.toLocaleString();
                totalEl.textContent = total.toLocaleString();
            }

            // 驗證與登出按鈕
            authBtn.addEventListener('click', async () => {
                if (patInput.disabled) {
                    // 已驗證，執行登出
                    location.reload();
                } else {
                    // 未驗證，執行 PAT 驗證
                    try {
                        authBtn.disabled = true;
                        const pat = patInput.value.trim();
                        if (!pat) {
                            patError.textContent = '請輸入有效的 PAT！';
                            patError.classList.add('show');
                            alert('請輸入有效的 PAT！');
                            return;
                        }

                        // 驗證 PAT
                        const response = await fetch('https://api.github.com/user', {
                            headers: {
                                'Authorization': `token ${pat}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            const errorMsg = errorData.message || response.statusText;
                            throw new Error(`PAT 驗證失敗：${errorMsg}`);
                        }

                        // 驗證成功
                        quoteSection.classList.remove('hidden');
                        countdownTimer.classList.remove('hidden');
                        patError.classList.remove('show');
                        patInput.classList.add('disabled');
                        patInput.readonly = true;
                        patInput.disabled = true;
                        authBtn.textContent = '登出';

                        // 啟動倒數計時器
                        const startTime = Date.now();
                        const countdownInterval = setInterval(() => {
                            const elapsed = Math.floor((Date.now() - startTime) / 1000);
                            const remaining = 900 - elapsed;
                            if (remaining <= 0) {
                                clearInterval(countdownInterval);
                                countdownTimer.textContent = '時間到，正在登出...';
                                location.reload();
                            } else {
                                countdownTimer.textContent = `還剩 ${remaining} 秒，登出報價系統`;
                            }
                        }, 1000);

                        // 初始化報價預覽
                        updateQuotePreview();
                        alert('驗證成功，正在載入報價系統...');
                    } catch (error) {
                        patError.textContent = error.message;
                        patError.classList.add('show');
                        alert(error.message);
                    } finally {
                        authBtn.disabled = false;
                    }
                }
            });

            // 綁定輸入與下拉選單事件
            [clientName, clientContact, clientEmail, clientNotes, additionalNotes, frontendLevel, backendLevel, seoLevel, hostingLevel, maintenanceLevel, discountSelect, frontendNotes, backendNotes, seoNotes, hostingNotes, maintenanceNotes, discountNotes].forEach(input => {
                input.addEventListener('input', updateQuotePreview);
            });

            // 確定帶入報價單按鈕
            confirmNotesBtn.addEventListener('click', async () => {
                confirmNotesBtn.disabled = true;
                try {
                    await saveQuoteData();
                    alert('報價單資料已儲存並帶入報價單！');
                } finally {
                    confirmNotesBtn.disabled = false;
                }
            });

            // 上傳檔案至伺服器
            async function uploadFileToServer(blob, filename, folder) {
                const formData = new FormData();
                formData.append('file', blob, filename);
                formData.append('folder', folder); // 指定儲存資料夾 (word 或 pdf)
                try {
                    const response = await fetch('/jim/quote/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (response.ok) {
                        console.log(`上傳 ${filename} 至 /jim/quote/${folder} 成功`);
                        return true;
                    } else {
                        throw new Error(`上傳失敗：${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('上傳錯誤:', error);
                    alert(`上傳 ${filename} 失敗：${error.message}`);
                    return false;
                }
            }

            // 產生報價單
            generateQuoteBtn.addEventListener('click', async () => {
                generateQuoteBtn.disabled = true;
                try {
                    const orderNumber = orderNumberEl.textContent.replace('報價單編號：', '');
                    const wordFilename = `報價單_${orderNumber}.docx`;
                    const pdfFilename = `報價單_${orderNumber}.pdf`;

                    // 從 temp.txt 或 localStorage 讀取報價單資料
                    const quoteData = await fetchQuoteData();

                    // 生成 Word 報價單
                    const doc = new docx.Document({
                        sections: [{
                            properties: {},
                            children: [
                                new docx.Paragraph({
                                    children: [
                                        new docx.ImageRun({
                                            data: await fetch('/img/logo.jpg').then(res => res.arrayBuffer()),
                                            transformation: { width: 150, height: 150 }
                                        }),
                                        new docx.TextRun({
                                            text: '123go形象網站設計報價單',
                                            bold: true,
                                            size: 32,
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: orderNumberEl.textContent,
                                            size: 24,
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: `日期：${quoteDateEl.textContent} | 有效期限：${quoteExpiryEl.textContent}`,
                                            size: 24,
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: `客戶名稱：${quoteData.clientName}`,
                                            size: 24,
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: `客戶電話/Line：${quoteData.clientContact}`,
                                            size: 24,
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: `客戶 E-mail：${quoteData.clientEmail}`,
                                            size: 24,
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: `附註：${quoteData.clientNotes}`,
                                            size: 24,
                                            break: 1
                                        })
                                    ]
                                }),
                                new docx.Table({
                                    rows: [
                                        new docx.TableRow({
                                            children: [
                                                new docx.TableCell({ children: [new docx.Paragraph('服務項目')] }),
                                                new docx.TableCell({ children: [new docx.Paragraph('層級')] }),
                                                new docx.TableCell({ children: [new docx.Paragraph('費用 (NTD)')] })
                                            ]
                                        }),
                                        ...quoteData.services.filter(s => s.level !== 'none').map(service => new docx.TableRow({
                                            children: [
                                                new docx.TableCell({ children: [new docx.Paragraph(service.notes ? `${service.name}（${service.notes}）` : service.name)] }),
                                                new docx.TableCell({ children: [new docx.Paragraph(service.level === 'basic' ? '基礎' : service.level === 'advanced' ? '進階' : service.level === 'premium' ? '高階' : service.level === 'full' ? '全包折扣' : '無')] }),
                                                new docx.TableCell({ children: [new docx.Paragraph(service.price.toLocaleString())] })
                                            ]
                                        })),
                                        new docx.TableRow({
                                            children: [
                                                new docx.TableCell({ children: [new docx.Paragraph('小計')], columnSpan: 2 }),
                                                new docx.TableCell({ children: [new docx.Paragraph(subtotalEl.textContent)] })
                                            ]
                                        }),
                                        new docx.TableRow({
                                            children: [
                                                new docx.TableCell({ children: [new docx.Paragraph('折扣')], columnSpan: 2 }),
                                                new docx.TableCell({ children: [new docx.Paragraph(discountAmountEl.textContent)] })
                                            ]
                                        }),
                                        new docx.TableRow({
                                            children: [
                                                new docx.TableCell({ children: [new docx.Paragraph('營業稅 (5%)')], columnSpan: 2 }),
                                                new docx.TableCell({ children: [new docx.Paragraph(taxEl.textContent)] })
                                            ]
                                        }),
                                        new docx.TableRow({
                                            children: [
                                                new docx.TableCell({ children: [new docx.Paragraph('總計')], columnSpan: 2 }),
                                                new docx.TableCell({ children: [new docx.Paragraph(totalEl.textContent)] })
                                            ]
                                        })
                                    ]
                                }),
                                new docx.Paragraph({
                                    children: [
                                        new docx.TextRun({
                                            text: '付款條款：30% 訂金，50% 初稿完成後，20% 上線後。',
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: '備註：包含 2 次免費修改，額外修改每次 500 元。專案預計 6 週完成。',
                                            break: 1
                                        }),
                                        new docx.TextRun({
                                            text: `補充說明：${quoteData.additionalNotes}`,
                                            break: 1
                                        })
                                    ]
                                })
                            ]
                        }]
                    });

                    // 生成並下載 Word
                    const wordBlob = await docx.Packer.toBlob(doc);
                    const wordUrl = window.URL.createObjectURL(wordBlob);
                    const wordLink = document.createElement('a');
                    wordLink.href = wordUrl;
                    wordLink.download = wordFilename;
                    wordLink.click();
                    window.URL.revokeObjectURL(wordUrl);

                    // 上傳 Word 至 /jim/quote/word
                    await uploadFileToServer(wordBlob, wordFilename, 'word');

                    // 生成並下載 PDF
                    const element = document.getElementById('quote-preview');
                    const pdfBlob = await html2pdf().from(element).set({
                        margin: 1,
                        filename: pdfFilename,
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    }).toPdf().get('pdf').then(pdf => pdf.output('blob'));
                    const pdfUrl = window.URL.createObjectURL(pdfBlob);
                    const pdfLink = document.createElement('a');
                    pdfLink.href = pdfUrl;
                    pdfLink.download = pdfFilename;
                    pdfLink.click();
                    window.URL.revokeObjectURL(pdfUrl);

                    // 上傳 PDF 至 /jim/quote/pdf
                    await uploadFileToServer(pdfBlob, pdfFilename, 'pdf');

                    // 更新訂單序號
                    await updateOrderNumber();

                    // 顯示提示框
                    alert(`報價單編號 ${orderNumber} 已完成！`);

                    // 重置畫面
                    resetForm();

                    // 更新報價預覽以顯示新編號
                    await updateQuotePreview();
                } catch (error) {
                    console.error('產生報價單錯誤:', error);
                    alert(`產生報價單失敗：${error.message}`);
                } finally {
                    generateQuoteBtn.disabled = false;
                }
            });
        });
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'932f5d2dfff2bd20',t:'MTc0NTA5Njc2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
```