<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>123go形象網站設計報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sanitize-html/2.13.0/sanitize-html.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #E5E7EB, #D1D5DB);
            font-family: 'Noto Sans TC', sans-serif;
        }
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0;
        }
        .header {
            background: #2563EB;
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .card {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-4px);
        }
        .card h2 {
            font-size: 1.5rem;
            color: #4A4A4A;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            color: #4A4A4A;
            margin-bottom: 8px;
        }
        input[type="password"], input[type="text"], input[type="email"], input[type="number"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            transition: border-color 0.2s ease;
        }
        input[type="password"]:focus, input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            border-color: #2563EB;
            outline: none;
        }
        select {
            max-width: 200px;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .error {
            color: #EF4444;
            display: none;
            margin-top: 8px;
            font-size: 0.9rem;
            transition: opacity 0.2s ease;
            opacity: 0;
        }
        .error.show {
            display: block;
            opacity: 1;
        }
        .btn {
            display: block;
            width: 200px;
            margin: 30px auto 0;
            padding: 12px;
            background: #2563EB;
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            text-align: center;
        }
        .btn:hover {
            background: #3B82F6;
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn:disabled {
            background: #6B7280;
            cursor: not-allowed;
        }
        input.disabled, textarea.disabled {
            background: #E5E7EB;
            cursor: not-allowed;
            color: #4A4A4A;
        }
        #countdown-timer {
            background: #DBEAFE;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1F2937;
        }
        #quote-preview {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        #quote-preview img {
            max-width: 150px;
            margin-bottom: 10px;
        }
        #quote-preview .signature-field {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }
        #quote-preview .signature-box {
            width: 80mm;
            height: 20mm;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            padding: 5px;
            box-sizing: border-box;
        }
        #quote-preview .signature-label {
            font-size: 14px;
            color: #1F2937;
            margin-right: 10px;
        }
        #quote-preview .signature-line {
            flex-grow: 1;
            border: none;
            border-top: 1px solid #000;
            margin: 0 5px;
        }
        /* 切換標籤樣式 */
        .tabs {
            width: 100%;
            margin-bottom: 1rem;
        }
        .tab-list {
            display: flex;
            border-bottom: 2px solid #D1D5DB;
        }
        .tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
            color: #6B7280;
            cursor: pointer;
            transition: color 0.3s ease, border-bottom 0.3s ease;
        }
        .tab.active {
            color: #2563EB;
            border-bottom: 2px solid #2563EB;
        }
        .tab:hover {
            color: #3B82F6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* 報價單歸檔區域樣式 */
        #archiveSection {
            padding: 20px;
            background: #F9FAFB;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .archive-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .archive-group select {
            flex: 1;
            max-width: 300px;
        }
        .archive-group .btn {
            width: 150px;
            margin: 0;
        }
        @media (max-width: 768px) {
            .container {
                margin: 20px;
            }
            .header h1 {
                font-size: 1.5rem;
                white-space: nowrap;
            }
            .card {
                padding: 15px;
            }
            .card h2 {
                font-size: 1.2rem;
            }
            .btn {
                width: 100%;
            }
            #quote-preview .signature-box {
                width: 60%;
                height: 15mm;
            }
            #quote-preview .signature-label {
                font-size: 12px;
            }
            .tab {
                font-size: 1rem;
                padding: 8px 0;
            }
            .archive-group {
                flex-direction: column;
                align-items: stretch;
            }
            .archive-group select {
                max-width: none;
            }
            .archive-group .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>123go形象網站設計報價系統</h1>
        </div>
        <div class="content">
            <!-- 倒數計時器 -->
            <div id="countdown-timer" class="hidden text-center text-lg font-semibold text-gray-700 bg-blue-100 p-4 rounded-lg mb-4 shadow"></div>
            <!-- 認證 -->
            <div class="card">
                <h2>認證設置</h2>
                <div class="input-group">
                    <label for="pat">Personal Access Token</label>
                    <input type="password" id="pat" placeholder="輸入您的 PAT">
                    <p id="pat-error" class="error">請輸入有效的 PAT！</p>
                </div>
                <button id="auth-btn" class="btn">驗證</button>
            </div>
            <!-- 切換標籤 -->
            <div id="tabContainer" class="tabs hidden">
                <div class="tab-list">
                    <div class="tab active" data-tab="quote">報價單產生</div>
                    <div class="tab" data-tab="archive">報價單歸檔</div>
                </div>
                <div id="quoteTab" class="tab-content active">
                    <!-- 報價單生成 -->
                    <div id="quoteSection" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 客戶資訊 -->
                        <div class="card col-span-1 md:col-span-2">
                            <h2>客戶資訊</h2>
                            <div class="input-group">
                                <label for="clientName">客戶名稱</label>
                                <input type="text" id="clientName" placeholder="輸入客戶名稱">
                            </div>
                            <div class="input-group">
                                <label for="clientContact">客戶電話/Line</label>
                                <input type="text" id="clientContact" placeholder="輸入電話或Line ID">
                            </div>
                            <div class="input-group">
                                <label for="clientEmail">客戶 E-mail</label>
                                <input type="email" id="clientEmail" placeholder="輸入E-mail">
                            </div>
                            <div class="input-group">
                                <label for="clientNotes">附註</label>
                                <textarea id="clientNotes" placeholder="輸入附註"></textarea>
                            </div>
                        </div>
                        <!-- 前端設計 -->
                        <div class="card">
                            <h2>前端設計</h2>
                            <div class="input-group">
                                <label for="frontendLevel">選擇服務層級</label>
                                <select id="frontendLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎 ($10,000)</option>
                                    <option value="advanced">進階 ($20,000)</option>
                                    <option value="premium">高階 ($30,000)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="frontendNotes">自訂功能描述</label>
                                <input type="text" id="frontendNotes" placeholder="輸入自訂功能（例如：留言板、寄信模組）">
                            </div>
                        </div>
                        <!-- 後端設計 -->
                        <div class="card">
                            <h2>後端開發</h2>
                            <div class="input-group">
                                <label for="backendLevel">選擇服務層級</label>
                                <select id="backendLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎 ($13,000)</option>
                                    <option value="advanced">進階 ($23,000)</option>
                                    <option value="premium">高階 ($33,000)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="backendNotes">自訂功能描述</label>
                                <input type="text" id="backendNotes" placeholder="輸入自訂功能（例如：資料庫管理、API整合）">
                            </div>
                        </div>
                        <!-- SEO -->
                        <div class="card">
                            <h2>SEO</h2>
                            <div class="input-group">
                                <label for="seoLevel">選擇服務層級</label>
                                <select id="seoLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎 ($5,000)</option>
                                    <option value="advanced">進階 ($10,000)</option>
                                    <option value="premium">高階 ($20,000)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="seoNotes">自訂功能描述</label>
                                <input type="text" id="seoNotes" placeholder="輸入自訂功能（例如：關鍵字優化、內容行銷）">
                            </div>
                        </div>
                        <!-- 主機代管 -->
                        <div class="card">
                            <h2>主機代管</h2>
                            <div class="input-group">
                                <label for="hostingLevel">選擇服務層級</label>
                                <select id="hostingLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎 ($2,000/年)</option>
                                    <option value="advanced">進階 ($3,000/年)</option>
                                    <option value="premium">高階 ($5,000/年)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="hostingNotes">自訂功能描述</label>
                                <input type="text" id="hostingNotes" placeholder="輸入自訂功能（例如：雲端備份、SSL證書）">
                            </div>
                        </div>
                        <!-- 後續維護 -->
                        <div class="card">
                            <h2>後續維護</h2>
                            <div class="input-group">
                                <label for="maintenanceLevel">選擇層級</label>
                                <select id="maintenanceLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎 ($2,200/月)</option>
                                    <option value="advanced">進階 ($3,500/月)</option>
                                    <option value="premium">高階 ($5,200/月)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="maintenanceNotes">自訂功能描述</label>
                                <input type="text" id="maintenanceNotes" placeholder="輸入自訂功能（例如：定期更新、技術支援）">
                            </div>
                        </div>
                        <!-- 特殊功能 -->
                        <div class="card">
                            <h2>特殊功能</h2>
                            <div class="input-group">
                                <label for="specialFeatureLevel">選擇服務層級</label>
                                <select id="specialFeatureLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎</option>
                                    <option value="advanced">進階</option>
                                    <option value="premium">高階</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="specialFeaturePrice">價格 (NTD)</label>
                                <input type="number" id="specialFeaturePrice" placeholder="輸入價格" min="0">
                            </div>
                            <div class="input-group">
                                <label for="specialFeatureNotes">自訂功能描述</label>
                                <input type="text" id="specialFeatureNotes" placeholder="輸入自訂功能（例如：AI模組、第三方整合）">
                            </div>
                        </div>
                        <!-- 初次設定 -->
                        <div class="card">
                            <h2>初次設定</h2>
                            <div class="input-group">
                                <label for="initialSetupLevel">選擇服務層級</label>
                                <select id="initialSetupLevel">
                                    <option value="none">不選擇</option>
                                    <option value="basic">基礎 ($1,500)</option>
                                    <option value="advanced">進階 ($2,000)</option>
                                    <option value="premium">高階 ($3,500)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="initialSetupNotes">自訂功能描述</label>
                                <input type="text" id="initialSetupNotes" placeholder="輸入自訂功能（例如：環境設置、初始資料導入）">
                            </div>
                        </div>
                        <!-- 折扣 -->
                        <div class="card">
                            <h2>折扣</h2>
                            <div class="input-group">
                                <label for="discount">選擇折扣</label>
                                <select id="discount">
                                    <option value="none">無折扣</option>
                                    <option value="full5">全包折扣 (5%)</option>
                                    <option value="full10">全包折扣 (10%)</option>
                                    <option value="full15">全包折扣 (15%)</option>
                                    <option value="full20">全包折扣 (20%)</option>
                                    <option value="full25">全包折扣 (25%)</option>
                                    <option value="full30">全包折扣 (30%)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="discountNotes">自訂功能描述</label>
                                <input type="text" id="discountNotes" placeholder="輸入自訂功能（例如：促銷活動、長期合作）">
                            </div>
                        </div>
                        <!-- 補充說明 -->
                        <div class="card col-span-1 md:col-span-2">
                            <h2>補充說明</h2>
                            <div class="input-group">
                                <label for="additionalNotes">補充說明</label>
                                <textarea id="additionalNotes" placeholder="輸入補充說明"></textarea>
                            </div>
                            <div class="input-group">
                                <label for="useTax">是否使用營業稅</label>
                                <select id="useTax">
                                    <option value="use-tax">使用營業稅</option>
                                    <option value="no-tax">不使用營業稅</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="salesRole">報價人員職稱</label>
                                <select id="salesRole">
                                    <option value="salesRep" selected>業務專員</option>
                                    <option value="assistantManager">業務副理</option>
                                    <option value="manager">業務經理</option>
                                    <option value="ceo">執行長</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="salesName">報價人員姓名</label>
                                <input type="text" id="salesName" placeholder="輸入報價人員姓名">
                            </div>
                            <div class="input-group">
                                <label for="salesContact">報價人員電話/Line</label>
                                <input type="text" id="salesContact" placeholder="輸入電話或Line ID">
                            </div>
                            <div class="input-group">
                                <label for="salesEmail">報價人員 E-mail</label>
                                <input type="email" id="salesEmail" placeholder="輸入E-mail">
                            </div>
                            <button id="confirm-notes-btn" class="btn">確定帶入報價單</button>
                        </div>
                        <!-- 報價預覽 -->
                        <div id="quote-preview" class="card col-span-1 md:col-span-2">
                            <img src="/img/logo.jpg" alt="123go Logo">
                            <h2>123go形象網站設計報價單</h2>
                            <p id="order-number">報價單編號：載入中...</p>
                            <p>日期：<span id="quote-date"></span> | 有效期限：<span id="quote-expiry"></span></p>
                            <div class="mt-4">
                                <p><strong>客戶名稱：</strong> <span id="preview-clientName">未輸入</span></p>
                                <p><strong>客戶電話/Line：</strong> <span id="preview-clientContact">未輸入</span></p>
                                <p><strong>客戶 E-mail：</strong> <span id="preview-clientEmail">未輸入</span></p>
                                <p><strong>附註：</strong> <span id="preview-clientNotes">未輸入</span></p>
                            </div>
                            <table class="w-full border-collapse mt-4">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="border p-2">服務項目</th>
                                        <th class="border p-2">層級</th>
                                        <th class="border p-2">費用 (NTD)</th>
                                    </tr>
                                </thead>
                                <tbody id="quote-table-body"></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2" class="border p-2 text-right font-semibold">小計</td>
                                        <td id="subtotal" class="border p-2">0</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" class="border p-2 text-right font-semibold">折扣</td>
                                        <td id="discount-amount" class="border p-2">0</td>
                                    </tr>
                                    <tr id="tax-row">
                                        <td colspan="2" class="border p-2 text-right font-semibold">營業稅 (5%)</td>
                                        <td id="tax" class="border p-2">0</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" class="border p-2 text-right font-semibold">總計</td>
                                        <td id="total" class="border p-2">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <p class="mt-4">付款條款：30% 訂金，50% 初稿完成後，20% 上線後。</p>
                            <p>備註：包含 2 次免費修改，額外修改每次 5,000 元。專案預計 6 週完成。</p>
                            <p><strong>補充說明：</strong> <span id="preview-additionalNotes">未輸入</span></p>
                            <div id="payment-terms" class="mt-4">
                                <p><strong>付款條款：</strong></p>
                                <ul class="list-disc pl-5">
                                    <li>30% 訂金：<span id="deposit">NT$ 0</span></li>
                                    <li>50% 初稿完成後：<span id="draft">NT$ 0</span></li>
                                    <li>20% 上線後：<span id="launch">NT$ 0</span></li>
                                </ul>
                            </div>
                            <div id="sales-info" class="mt-4">
                                <p><strong>報價人員職稱：</strong> <span id="preview-salesRole">未輸入</span></p>
                                <p><strong>報價人員姓名：</strong> <span id="preview-salesName">未輸入</span></p>
                                <p><strong>報價人員電話/Line：</strong> <span id="preview-salesContact">未輸入</span></p>
                                <p><strong>報價人員 E-mail：</strong> <span id="preview-salesEmail">未輸入</span></p>
                            </div>
                            <!-- 客戶簽名欄位 -->
                            <div class="signature-field">
                                <div class="signature-box">
                                    <span class="signature-label">客戶簽名</span>
                                    <hr class="signature-line">
                                </div>
                            </div>
                        </div>
                        <!-- 產生報價單按鈕 -->
                        <button id="generate-quote-btn" class="btn">產生報價單</button>
                        <!-- 清除報價單內容按鈕 -->
                        <button id="clear-quote-btn" class="btn">清除報價單內容</button>
                    </div>
                </div>
                <div id="archiveTab" class="tab-content">
                    <!-- 報價單歸檔 -->
                    <div id="archiveSection">
                        <h2 class="text-xl font-semibold mb-4">報價單歸檔</h2>
                        <div class="archive-group">
                            <select id="pdfFiles" class="border p-2 rounded">
                                <option value="">請選擇報價單</option>
                            </select>
                            <button id="download-pdf-btn" class="btn">下載報價單</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 儲存 PAT 的全域變數
        let githubPAT = '';
        let isFetchingOrderNumber = false; // 防抖控制

        // 獲取訂單編號，使用 sql-tech/database 的 Issue #2
        async function getOrderNumber() {
            if (isFetchingOrderNumber) {
                console.warn('正在獲取訂單編號，請稍後...');
                return null;
            }
            if (!githubPAT) {
                console.error('未設置 GitHub PAT');
                alert('請先驗證 PAT！');
                return null;
            }
            isFetchingOrderNumber = true;

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const key = `${year}-${month}`; // 例如 "2025-04"
            const retries = 3;

            try {
                // 檢查 localStorage 備用計數器
                const localKey = `orderNumber_${key}`;
                let localSequence = parseInt(localStorage.getItem(localKey)) || 0;

                // 嘗試使用 GitHub API 更新序號
                for (let i = 0; i < retries; i++) {
                    try {
                        // 讀取 sql-tech/database 的 Issue #2 評論
                        console.log('發送請求至 GitHub API: issues/2/comments');
                        const response = await fetch('https://api.github.com/repos/sql-tech/database/issues/2/comments', {
                            headers: {
                                'Authorization': `token ${githubPAT}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`無法獲取評論：${response.status} ${response.statusText} ${errorData.message || ''}`);
                        }
                        const comments = await response.json();
                        console.log('從 GitHub Issue #2 讀取的評論:', comments);
                        const lastComment = comments.length > 0 ? comments[comments.length - 1].body : '';
                        const match = lastComment.match(new RegExp(`${key}: (\\d+)`));
                        let sequence = match ? parseInt(match[1]) : 0;

                        // 與 localStorage 比較，取較大值
                        sequence = Math.max(sequence, localSequence);
                        sequence += 1;

                        // 檢查序號範圍
                        if (sequence > 99999) {
                            throw new Error(`序號已達到上限 (99999)，請聯繫管理員處理！`);
                        }

                        // 寫入新評論
                        console.log('寫入新評論至 GitHub Issue #2');
                        const updateResponse = await fetch('https://api.github.com/repos/sql-tech/database/issues/2/comments', {
                            method: 'POST',
                            headers: {
                                'Authorization': `token ${githubPAT}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ body: `${key}: ${sequence.toString().padStart(5, '0')}` })
                        });
                        if (!updateResponse.ok) {
                            const errorData = await updateResponse.json().catch(() => ({}));
                            const errorMsg = errorData.message || updateResponse.statusText;
                            throw new Error(`無法寫入評論：${updateResponse.status} ${errorMsg}`);
                        }
                        console.log(`成功寫入新評論: ${key}: ${sequence.toString().padStart(5, '0')}`);

                        // 更新 localStorage
                        localStorage.setItem(localKey, sequence.toString());
                        return `${year}-${month}-${sequence.toString().padStart(5, '0')}`;
                    } catch (error) {
                        if (error.message.includes('409') && i < retries - 1) {
                            console.warn('檢測到並發衝突，重試中...');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        throw error;
                    }
                }
                throw new Error('重試失敗，請檢查 GitHub API 或 PAT');
            } catch (error) {
                console.error('獲取訂單編號錯誤:', error);
                alert(`獲取訂單編號失敗：${error.message}\n正在使用本地計數器作為備用方案。`);

                // 備用方案：使用 localStorage 計數
                const localKey = `orderNumber_${key}`;
                let localSequence = parseInt(localStorage.getItem(localKey)) || 0;
                localSequence += 1;

                // 檢查序號範圍
                if (localSequence > 99999) {
                    alert(`本地序號已達到上限 (99999)，請聯繫管理員處理！`);
                    return null;
                }

                localStorage.setItem(localKey, localSequence.toString());
                console.log(`使用本地計數器: ${key}: ${localSequence.toString().padStart(5, '0')}`);
                return `${year}-${month}-${localSequence.toString().padStart(5, '0')}`;
            } finally {
                isFetchingOrderNumber = false;
            }
        }

        async function updateOrderNumber() {
            // 空函數，序號更新由 getOrderNumber 處理
        }

        // GitHub API 上傳函數
        async function uploadToGitHub(token, path, base64Content, fileName) {
            console.log('開始上傳至 GitHub: ' + path);
            try {
                const repo = 'sql-tech/123go';
                let sha = null;
                try {
                    const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const getData = await getResponse.json();
                        sha = getData.sha;
                        console.log('獲取檔案 SHA: ' + sha);
                    } else if (getResponse.status === 404) {
                        console.log('檔案不存在，將創建新檔案');
                    } else {
                        const errorData = await getResponse.json().catch(() => ({}));
                        const errorMsg = errorData.message || getResponse.statusText;
                        console.error(`獲取檔案資訊失敗，狀態碼: ${getResponse.status}, 訊息: ${errorMsg}`);
                        alert(`獲取檔案資訊失敗：${errorMsg}`);
                        return false;
                    }
                } catch (error) {
                    console.warn('獲取 SHA 失敗，可能為新檔案:', error.message);
                }

                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `上傳 ${fileName}`,
                        content: base64Content,
                        sha: sha
                    })
                });

                if (response.ok) {
                    console.log('GitHub API 上傳成功: ' + path);
                    return true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.message || response.statusText;
                    console.error(`GitHub API 上傳失敗: ${errorMsg}`);
                    alert(`上傳失敗: ${errorMsg}`);
                    return false;
                }
            } catch (error) {
                console.error('上傳至 GitHub 錯誤:', error.message);
                alert(`上傳至 GitHub 失敗：${error.message}`);
                return false;
            }
        }

        // 從 GitHub 讀取 PDF 檔案列表
        async function fetchPDFFiles() {
            const pdfFilesSelect = document.getElementById('pdfFiles');
            pdfFilesSelect.innerHTML = '<option value="">請選擇報價單</option>';

            try {
                console.log('發送請求至 GitHub API: 讀取 /jim/quote/pdf 資料夾');
                const response = await fetch('https://api.github.com/repos/sql-tech/123go/contents/jim/quote/pdf', {
                    headers: {
                        'Authorization': `token ${githubPAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.message || response.statusText;
                    throw new Error(`無法讀取 PDF 檔案列表：${response.status} ${errorMsg}`);
                }
                const files = await response.json();
                console.log('從 GitHub 讀取的檔案列表:', files);

                // 過濾 .pdf 檔案並填充到下拉式選單
                const pdfFiles = files.filter(file => file.name.endsWith('.pdf'));
                pdfFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.name;
                    option.textContent = file.name;
                    pdfFilesSelect.appendChild(option);
                });

                if (pdfFiles.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '無報價單檔案';
                    pdfFilesSelect.appendChild(option);
                }
            } catch (error) {
                console.error('讀取 PDF 檔案列表錯誤:', error);
                alert(`讀取報價單檔案失敗：${error.message}`);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '無法載入檔案';
                pdfFilesSelect.appendChild(option);
            }
        }

        // 下載選中的 PDF 檔案
        async function downloadPDFFile() {
            const pdfFilesSelect = document.getElementById('pdfFiles');
            const selectedFile = pdfFilesSelect.value;

            if (!selectedFile) {
                alert('請選擇一個報價單檔案！');
                return;
            }

            try {
                console.log(`發送請求至 GitHub API: 下載檔案 ${selectedFile}`);
                const response = await fetch(`https://api.github.com/repos/sql-tech/123go/contents/jim/quote/pdf/${selectedFile}`, {
                    headers: {
                        'Authorization': `token ${githubPAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.message || response.statusText;
                    throw new Error(`無法下載檔案：${response.status} ${errorMsg}`);
                }
                const fileData = await response.json();
                console.log('檔案資料:', fileData);

                // 解碼 Base64 內容
                const base64Content = fileData.content;
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });

                // 觸發下載
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = selectedFile;
                link.click();
                window.URL.revokeObjectURL(url);

                alert(`報價單 ${selectedFile} 下載成功！`);
            } catch (error) {
                console.error('下載 PDF 檔案錯誤:', error);
                alert(`下載報價單失敗：${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 初始化元素
            const patInput = document.getElementById('pat');
            const authBtn = document.getElementById('auth-btn');
            const countdownTimer = document.getElementById('countdown-timer');
            const tabContainer = document.getElementById('tabContainer');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const patError = document.getElementById('pat-error');
            const clientName = document.getElementById('clientName');
            const clientContact = document.getElementById('clientContact');
            const clientEmail = document.getElementById('clientEmail');
            const clientNotes = document.getElementById('clientNotes');
            const additionalNotes = document.getElementById('additionalNotes');
            const useTax = document.getElementById('useTax');
            const salesRole = document.getElementById('salesRole');
            const salesName = document.getElementById('salesName');
            const salesContact = document.getElementById('salesContact');
            const salesEmail = document.getElementById('salesEmail');
            const confirmNotesBtn = document.getElementById('confirm-notes-btn');
            const frontendLevel = document.getElementById('frontendLevel');
            const backendLevel = document.getElementById('backendLevel');
            const seoLevel = document.getElementById('seoLevel');
            const hostingLevel = document.getElementById('hostingLevel');
            const maintenanceLevel = document.getElementById('maintenanceLevel');
            const initialSetupLevel = document.getElementById('initialSetupLevel');
            const specialFeatureLevel = document.getElementById('specialFeatureLevel');
            const specialFeaturePrice = document.getElementById('specialFeaturePrice');
            const discountSelect = document.getElementById('discount');
            const frontendNotes = document.getElementById('frontendNotes');
            const backendNotes = document.getElementById('backendNotes');
            const seoNotes = document.getElementById('seoNotes');
            const hostingNotes = document.getElementById('hostingNotes');
            const maintenanceNotes = document.getElementById('maintenanceNotes');
            const initialSetupNotes = document.getElementById('initialSetupNotes');
            const specialFeatureNotes = document.getElementById('specialFeatureNotes');
            const discountNotes = document.getElementById('discountNotes');
            const quoteTableBody = document.getElementById('quote-table-body');
            const subtotalEl = document.getElementById('subtotal');
            const discountAmountEl = document.getElementById('discount-amount');
            const taxEl = document.getElementById('tax');
            const taxRow = document.getElementById('tax-row');
            const totalEl = document.getElementById('total');
            const orderNumberEl = document.getElementById('order-number');
            const quoteDateEl = document.getElementById('quote-date');
            const quoteExpiryEl = document.getElementById('quote-expiry');
            const previewClientName = document.getElementById('preview-clientName');
            const previewClientContact = document.getElementById('preview-clientContact');
            const previewClientEmail = document.getElementById('preview-clientEmail');
            const previewClientNotes = document.getElementById('preview-clientNotes');
            const previewAdditionalNotes = document.getElementById('preview-additionalNotes');
            const previewSalesRole = document.getElementById('preview-salesRole');
            const previewSalesName = document.getElementById('preview-salesName');
            const previewSalesContact = document.getElementById('preview-salesContact');
            const previewSalesEmail = document.getElementById('preview-salesEmail');
            const depositEl = document.getElementById('deposit');
            const draftEl = document.getElementById('draft');
            const launchEl = document.getElementById('launch');
            const generateQuoteBtn = document.getElementById('generate-quote-btn');
            const clearQuoteBtn = document.getElementById('clear-quote-btn');
            const downloadPDFBtn = document.getElementById('download-pdf-btn');

            // 檢查元素是否正確獲取
            console.log('authBtn:', authBtn);
            if (!authBtn) {
                console.error('無法找到 authBtn 元素，請檢查 DOM');
                alert('頁面載入錯誤，請重新載入頁面！');
                return;
            }

            // 價格表
            const prices = {
                frontend: { basic: 10000, advanced: 20000, premium: 30000 },
                backend: { basic: 13000, advanced: 23000, premium: 33000 },
                seo: { basic: 5000, advanced: 10000, premium: 20000 },
                hosting: { basic: 2000, advanced: 3000, premium: 5000 },
                maintenance: { basic: 2200, advanced: 3500, premium: 5200 },
                initialSetup: { basic: 1500, advanced: 2000, premium: 3500 }
            };

            // 折扣百分比表
            const discountRates = {
                none: 0,
                full5: 0.05,
                full10: 0.10,
                full15: 0.15,
                full20: 0.20,
                full25: 0.25,
                full30: 0.30
            };

            // 職稱對應顯示名稱
            const roleDisplayNames = {
                salesRep: '業務專員',
                assistantManager: '業務副理',
                manager: '業務經理',
                ceo: '執行長'
            };

            // 清理輸入以防止 XSS
            function sanitizeInput(input) {
                if (typeof sanitizeHtml === 'function') {
                    return sanitizeHtml(input, {
                        allowedTags: [],
                        allowedAttributes: {}
                    });
                } else {
                    console.warn('sanitizeHtml 未定義，使用基本清理');
                    return input.replace(/[<>&"']/g, '');
                }
            }

            // 儲存報價單資料到後端或 localStorage
            async function saveQuoteData() {
                try {
                    const quoteData = {
                        clientName: sanitizeInput(clientName.value),
                        clientContact: sanitizeInput(clientContact.value),
                        clientEmail: sanitizeInput(clientEmail.value),
                        clientNotes: sanitizeInput(clientNotes.value),
                        additionalNotes: sanitizeInput(additionalNotes.value),
                        useTax: useTax.value,
                        salesRole: salesRole.value,
                        salesName: sanitizeInput(salesName.value),
                        salesContact: sanitizeInput(salesContact.value),
                        salesEmail: sanitizeInput(salesEmail.value),
                        services: [
                            { name: '前端設計', level: frontendLevel.value, price: prices.frontend[frontendLevel.value] || 0, notes: sanitizeInput(frontendNotes.value) },
                            { name: '後端開發', level: backendLevel.value, price: prices.backend[backendLevel.value] || 0, notes: sanitizeInput(backendNotes.value) },
                            { name: 'SEO', level: seoLevel.value, price: prices.seo[seoLevel.value] || 0, notes: sanitizeInput(seoNotes.value) },
                            { name: '主機代管', level: hostingLevel.value, price: prices.hosting[hostingLevel.value] || 0, notes: sanitizeInput(hostingNotes.value) },
                            { name: '後續維護', level: maintenanceLevel.value, price: prices.maintenance[maintenanceLevel.value] || 0, notes: sanitizeInput(maintenanceNotes.value) },
                            { name: '特殊功能', level: specialFeatureLevel.value, price: parseFloat(specialFeaturePrice.value) || 0, notes: sanitizeInput(specialFeatureNotes.value) },
                            { name: '初次設定', level: initialSetupLevel.value, price: prices.initialSetup[initialSetupLevel.value] || 0, notes: sanitizeInput(initialSetupNotes.value) },
                            { name: '折扣', level: discountSelect.value, price: 0, notes: sanitizeInput(discountNotes.value) }
                        ]
                    };
                    console.log('儲存報價資料:', quoteData);
                    try {
                        const response = await fetch('/jim/quote/save-temp', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(quoteData)
                        });
                        if (response.ok) {
                            console.log('報價單資料已儲存至後端');
                            updateQuotePreview();
                            return;
                        } else {
                            throw new Error(`儲存失敗：${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.warn('後端儲存失敗，改用 localStorage:', error);
                        localStorage.setItem('quoteData', JSON.stringify(quoteData));
                        console.log('報價單資料已儲存至 localStorage');
                        updateQuotePreview();
                    }
                } catch (error) {
                    console.error('儲存報價單資料錯誤:', error);
                    alert(`儲存報價單資料失敗：${error.message}`);
                }
            }

            // 從後端或 localStorage 讀取報價單資料
            async function fetchQuoteData() {
                const defaultQuoteData = {
                    clientName: '未輸入',
                    clientContact: '未輸入',
                    clientEmail: '未輸入',
                    clientNotes: '未輸入',
                    additionalNotes: '未輸入',
                    useTax: 'no-tax',
                    salesRole: 'salesRep',
                    salesName: '未輸入',
                    salesContact: '未輸入',
                    salesEmail: '未輸入',
                    services: [
                        { name: '前端設計', level: 'none', price: 0, notes: '' },
                        { name: '後端開發', level: 'none', price: 0, notes: '' },
                        { name: 'SEO', level: 'none', price: 0, notes: '' },
                        { name: '主機代管', level: 'none', price: 0, notes: '' },
                        { name: '後續維護', level: 'none', price: 0, notes: '' },
                        { name: '特殊功能', level: 'none', price: 0, notes: '' },
                        { name: '初次設定', level: 'none', price: 0, notes: '' },
                        { name: '折扣', level: 'none', price: 0, notes: '' }
                    ]
                };

                try {
                    console.log('發送請求至後端 API: /jim/quote/read-temp');
                    const response = await fetch('/jim/quote/read-temp', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        console.log('從後端讀取的報價資料:', data);
                        if (data && Array.isArray(data.services)) {
                            data.useTax = ['use-tax', 'no-tax'].includes(data.useTax) ? data.useTax : 'no-tax';
                            return data;
                        } else {
                            console.warn('後端資料缺少 services，改用預設資料');
                            return defaultQuoteData;
                        }
                    } else {
                        throw new Error(`讀取失敗：${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn('後端讀取失敗，改用 localStorage:', error);
                    try {
                        const rawData = localStorage.getItem('quoteData');
                        if (!rawData) {
                            console.log('localStorage 無資料，返回預設資料');
                            return defaultQuoteData;
                        }
                        const data = JSON.parse(rawData);
                        console.log('從 localStorage 讀取的報價資料:', data);
                        if (data && Array.isArray(data.services)) {
                            data.useTax = ['use-tax', 'no-tax'].includes(data.useTax) ? data.useTax : 'no-tax';
                            return data;
                        } else {
                            console.warn('localStorage 資料無效，清除並返回預設資料');
                            localStorage.removeItem('quoteData');
                            return defaultQuoteData;
                        }
                    } catch (parseError) {
                        console.error('解析 localStorage 資料失敗:', parseError);
                        localStorage.removeItem('quoteData');
                        return defaultQuoteData;
                    }
                }
            }

            // 重置表單
            function resetForm() {
                clientName.value = '';
                clientContact.value = '';
                clientEmail.value = '';
                clientNotes.value = '';
                additionalNotes.value = '';
                useTax.value = 'no-tax';
                salesRole.value = 'salesRep';
                salesName.value = '';
                salesContact.value = '';
                salesEmail.value = '';
                frontendLevel.value = 'none';
                backendLevel.value = 'none';
                seoLevel.value = 'none';
                hostingLevel.value = 'none';
                maintenanceLevel.value = 'none';
                initialSetupLevel.value = 'none';
                specialFeatureLevel.value = 'none';
                specialFeaturePrice.value = '';
                discountSelect.value = 'none';
                frontendNotes.value = '';
                backendNotes.value = '';
                seoNotes.value = '';
                hostingNotes.value = '';
                maintenanceNotes.value = '';
                initialSetupNotes.value = '';
                specialFeatureNotes.value = '';
                discountNotes.value = '';
                localStorage.removeItem('quoteData');
                localStorage.removeItem('lastOrderNumber');
                updateQuotePreview();
            }

            // 更新報價預覽
            async function updateQuotePreview() {
                const today = new Date();
                const expiry = new Date(today);
                expiry.setDate(today.getDate() + 30);

                const lastOrderNumber = localStorage.getItem('lastOrderNumber') || '載入中...';
                orderNumberEl.textContent = `報價單編號：${lastOrderNumber}`;
                quoteDateEl.textContent = today.toLocaleDateString('zh-TW');
                quoteExpiryEl.textContent = expiry.toLocaleDateString('zh-TW');

                const quoteData = await fetchQuoteData();
                console.log('更新報價預覽的 quoteData:', quoteData);

                previewClientName.textContent = quoteData.clientName || '未輸入';
                previewClientContact.textContent = quoteData.clientContact || '未輸入';
                previewClientEmail.textContent = quoteData.clientEmail || '未輸入';
                previewClientNotes.textContent = quoteData.clientNotes || '未輸入';
                previewAdditionalNotes.textContent = quoteData.additionalNotes || '未輸入';

                previewSalesRole.textContent = roleDisplayNames[quoteData.salesRole] || '未輸入';
                previewSalesName.textContent = quoteData.salesName || '未輸入';
                previewSalesContact.textContent = quoteData.salesContact || '未輸入';
                previewSalesEmail.textContent = quoteData.salesEmail || '未輸入';

                const selectedServices = Array.isArray(quoteData.services) ? quoteData.services : [];
                console.log('selectedServices:', selectedServices);

                quoteTableBody.innerHTML = '';
                let subtotal = 0;
                selectedServices.forEach(service => {
                    if (service.name === '特殊功能' && service.level !== 'none') {
                        const price = parseFloat(service.price) || 0;
                        if (price <= 0) {
                            return;
                        }
                    }
                    if (service.level !== 'none') {
                        if (service.name !== '折扣') {
                            subtotal += service.price;
                        }
                        const row = document.createElement('tr');
                        const displayName = service.notes ? `${service.name}（${service.notes}）` : service.name;
                        row.innerHTML = `
                            <td class="border p-2">${displayName}</td>
                            <td class="border p-2">${service.level === 'basic' ? '基礎' : service.level === 'advanced' ? '進階' : service.level === 'premium' ? '高階' : service.level.startsWith('full') ? `全包折扣 (${service.level.replace('full', '')}%)` : '無'}</td>
                            <td class="border p-2">${service.price.toLocaleString()}</td>
                        `;
                        quoteTableBody.appendChild(row);
                    }
                });

                let discount = 0;
                const discountLevel = selectedServices.find(s => s.name === '折扣')?.level || 'none';
                if (discountLevel !== 'none' && subtotal > 0) {
                    discount = Math.round(subtotal * discountRates[discountLevel]);
                }
                const tax = useTax.value === 'use-tax' ? Math.round((subtotal - discount) * 0.05) : 0;
                const total = Math.round(subtotal - discount + tax);

                subtotalEl.textContent = subtotal.toLocaleString();
                discountAmountEl.textContent = discount.toLocaleString();
                taxEl.textContent = tax.toLocaleString();
                taxRow.style.display = useTax.value === 'use-tax' ? '' : 'none';
                totalEl.textContent = total.toLocaleString();

                depositEl.textContent = `NT$ ${Math.round(total * 0.3).toLocaleString()}`;
                draftEl.textContent = `NT$ ${Math.round(total * 0.5).toLocaleString()}`;
                launchEl.textContent = `NT$ ${Math.round(total * 0.2).toLocaleString()}`;
            }

            // 驗證與登出按鈕
            authBtn.addEventListener('click', async () => {
                console.log('驗證按鈕點擊開始');
                if (patInput.disabled) {
                    console.log('執行登出，重新載入頁面');
                    location.reload();
                } else {
                    try {
                        authBtn.disabled = true;
                        const pat = patInput.value.trim();
                        console.log('輸入的 PAT:', pat ? '[有值]' : '[無值]');
                        if (!pat) {
                            patError.textContent = '請輸入有效的 PAT！';
                            patError.classList.add('show');
                            alert('請輸入有效的 PAT！');
                            console.log('PAT 為空，終止驗證');
                            return;
                        }

                        console.log('發送請求至 GitHub API: /user');
                        const userResponse = await fetch('https://api.github.com/user', {
                            headers: {
                                'Authorization': `token ${pat}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        console.log('userResponse 狀態:', userResponse.status);
                        if (!userResponse.ok) {
                            const errorData = await userResponse.json().catch(() => ({}));
                            const errorMsg = errorData.message || userResponse.statusText;
                            throw new Error(`PAT 驗證失敗：${errorMsg}`);
                        }

                        console.log('發送請求至 GitHub API: /repos/sql-tech/database');
                        const repoResponse = await fetch('https://api.github.com/repos/sql-tech/database', {
                            headers: {
                                'Authorization': `token ${pat}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        console.log('repoResponse 狀態:', repoResponse.status);
                        if (!repoResponse.ok) {
                            throw new Error('PAT 無權限存取 sql-tech/database 儲存庫，請確認您是協作者');
                        }

                        githubPAT = pat;
                        tabContainer.classList.remove('hidden');
                        countdownTimer.classList.remove('hidden');
                        patError.classList.remove('show');
                        patInput.classList.add('disabled');
                        patInput.readonly = true;
                        patInput.disabled = true;
                        authBtn.textContent = '登出';
                        console.log('驗證成功，顯示報價系統');

                        const startTime = Date.now();
                        const countdownInterval = setInterval(() => {
                            const elapsed = Math.floor((Date.now() - startTime) / 1000);
                            const remaining = 900 - elapsed;
                            if (remaining <= 0) {
                                clearInterval(countdownInterval);
                                countdownTimer.textContent = '時間到，正在登出...';
                                console.log('倒數計時結束，重新載入頁面');
                                location.reload();
                            } else {
                                countdownTimer.textContent = `還剩 ${remaining} 秒，登出報價系統`;
                            }
                        }, 1000);

                        console.log('初始化報價預覽');
                        await updateQuotePreview();
                        await fetchPDFFiles(); // 初次載入 PDF 檔案列表
                        alert('驗證成功，正在載入報價系統...');
                    } catch (error) {
                        console.error('驗證錯誤:', error);
                        patError.textContent = error.message;
                        patError.classList.add('show');
                        alert(error.message);
                    } finally {
                        authBtn.disabled = false;
                        console.log('驗證按鈕處理完成');
                    }
                }
            });

            // 切換標籤功能
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    tab.classList.add('active');
                    const targetTab = document.getElementById(`${tab.dataset.tab}Tab`);
                    targetTab.classList.add('active');

                    // 如果切換到「報價單歸檔」標籤，刷新 PDF 檔案列表
                    if (tab.dataset.tab === 'archive') {
                        fetchPDFFiles();
                    }
                });
            });

            // 綁定輸入與下拉選單事件
            [clientName, clientContact, clientEmail, clientNotes, additionalNotes, useTax, salesRole, salesName, salesContact, salesEmail, frontendLevel, backendLevel, seoLevel, hostingLevel, maintenanceLevel, initialSetupLevel, specialFeatureLevel, specialFeaturePrice, discountSelect, frontendNotes, backendNotes, seoNotes, hostingNotes, maintenanceNotes, initialSetupNotes, specialFeatureNotes, discountNotes].forEach(input => {
                input.addEventListener('input', () => {
                    console.log(`輸入變更: ${input.id} = ${input.value}`);
                    updateQuotePreview();
                });
            });

            // 確定帶入報價單按鈕
            confirmNotesBtn.addEventListener('click', async () => {
                console.log('確定帶入報價單按鈕點擊');
                confirmNotesBtn.disabled = true;
                try {
                    await saveQuoteData();
                    alert('報價單資料已儲存並帶入報價單！');
                } finally {
                    confirmNotesBtn.disabled = false;
                }
            });

            // 清除報價單內容按鈕
            clearQuoteBtn.addEventListener('click', async () => {
                console.log('清除報價單內容按鈕點擊');
                clearQuoteBtn.disabled = true;
                try {
                    resetForm();
                    await updateQuotePreview();
                    alert('報價單內容已清除！');
                } finally {
                    clearQuoteBtn.disabled = false;
                }
            });

            // 下載報價單按鈕
            downloadPDFBtn.addEventListener('click', downloadPDFFile);

            // 產生報價單
            generateQuoteBtn.addEventListener('click', async () => {
                console.log('產生報價單按鈕點擊');
                generateQuoteBtn.disabled = true;
                try {
                    const orderNumber = await getOrderNumber();
                    if (!orderNumber) {
                        throw new Error('無法獲取訂單編號，請重試！');
                    }
                    orderNumberEl.textContent = `報價單編號：${orderNumber}`;
                    localStorage.setItem('lastOrderNumber', orderNumber);

                    const rawClientName = clientName.value.trim();
                    const clientNameSanitized = rawClientName ? sanitizeInput(rawClientName).replace(/[^a-zA-Z0-9_-]/g, '') : '';
                    const pdfFilename = `報價單_${orderNumber}${clientNameSanitized ? '_' + clientNameSanitized : ''}.pdf`;

                    const quoteData = await fetchQuoteData();

                    await updateQuotePreview();
                    await new Promise(resolve => setTimeout(resolve, 500));

                    console.log('檢查報價單圖片載入');
                    const img = document.querySelector('#quote-preview img');
                    if (img) {
                        console.log('等待圖片載入:', img.src);
                        await new Promise((resolve, reject) => {
                            if (img.complete && img.naturalWidth !== 0) {
                                resolve();
                            } else {
                                img.onload = resolve;
                                img.onerror = () => reject(new Error('報價單圖片載入失敗: ' + img.src));
                                setTimeout(() => reject(new Error('圖片載入超時')), 5000);
                            }
                        }).catch(error => {
                            console.warn('圖片載入失敗，將繼續生成 PDF:', error.message);
                        });
                    } else {
                        console.warn('未找到報價單圖片，將繼續生成 PDF');
                    }

                    const originalElement = document.getElementById('quote-preview');
                    if (!originalElement) {
                        throw new Error('無法找到報價單預覽元素');
                    }

                    // 克隆元素以避免影響原始排版
                    const clone = originalElement.cloneNode(true);
                    document.body.appendChild(clone);
                    clone.style.position = 'absolute';
                    clone.style.left = '0';
                    clone.style.top = '0';
                    clone.style.width = '190mm'; // A4 寬度減去邊距 (210mm - 10mm x 2)
                    clone.style.height = 'auto';
                    clone.style.backgroundColor = '#fff';
                    clone.style.padding = '10mm';
                    clone.style.boxShadow = 'none';
                    clone.style.borderRadius = '0';
                    clone.style.overflow = 'visible';
                    clone.style.transition = 'none';
                    clone.querySelectorAll('*').forEach(el => {
                        el.style.boxShadow = 'none';
                        el.style.borderRadius = '0';
                        el.style.transition = 'none';
                        if (el.tagName === 'TABLE') {
                            el.style.borderCollapse = 'collapse';
                            el.querySelectorAll('th, td').forEach(cell => {
                                cell.style.border = '1px solid #000';
                                cell.style.padding = '4px';
                            });
                        }
                    });

                    console.log('開始生成 PDF，目標元素:', clone);
                    try {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        });

                        const imgWidth = 190; // A4 寬度減去邊距 (210mm - 10mm x 2)
                        const pageHeightMM = 277 - 20; // A4 高度減去邊距 (297mm - 10mm x 2)
                        const scale = 794 / (imgWidth * 3.78); // 像素與 mm 的比例 (794px 對應 190mm)

                        // 第一次截圖以獲取總高度
                        const fullCanvas = await html2canvas(clone, {
                            scale: 1,
                            useCORS: true,
                            backgroundColor: '#fff',
                            logging: true,
                            width: 794
                        });
                        const totalHeightPx = fullCanvas.height;
                        const pageHeightPx = pageHeightMM * 3.78; // 轉換 mm 到像素
                        const totalPages = Math.ceil(totalHeightPx / pageHeightPx);

                        console.log(`總頁數: ${totalPages}, 總高度: ${totalHeightPx}px, 每頁高度: ${pageHeightPx}px`);

                        // 分段截圖並添加到 PDF
                        for (let page = 0; page < totalPages; page++) {
                            if (page > 0) pdf.addPage();

                            // 計算當前頁的截圖區域
                            const yOffsetPx = page * pageHeightPx;
                            const canvas = await html2canvas(clone, {
                                scale: 1,
                                useCORS: true,
                                backgroundColor: '#fff',
                                logging: true,
                                width: 794,
                                y: yOffsetPx,
                                height: Math.min(pageHeightPx, totalHeightPx - yOffsetPx),
                                windowHeight: totalHeightPx // 確保窗口高度足夠
                            });

                            const imgData = canvas.toDataURL('image/png', 0.8);
                            const imgHeightMM = (canvas.height / 3.78); // 轉換像素到 mm

                            // 添加圖片到 PDF
                            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeightMM, undefined, 'FAST');
                        }

                        const pdfBlob = pdf.output('blob');
                        console.log('PDF 生成成功，大小:', pdfBlob.size);

                        document.body.removeChild(clone);

                        const pdfUrl = window.URL.createObjectURL(pdfBlob);
                        const pdfLink = document.createElement('a');
                        pdfLink.href = pdfUrl;
                        pdfLink.download = pdfFilename;
                        pdfLink.click();
                        window.URL.revokeObjectURL(pdfUrl);

                        const reader = new FileReader();
                        const base64Content = await new Promise(resolve => {
                            reader.onload = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(pdfBlob);
                        });
                        const uploadPath = `jim/quote/pdf/${pdfFilename}`;
                        const uploadSuccess = await uploadToGitHub(githubPAT, uploadPath, base64Content, pdfFilename);
                        if (uploadSuccess) {
                            console.log(`PDF 上傳至 GitHub 成功: ${uploadPath}`);
                            alert(`報價單編號 ${orderNumber} 已完成並上傳至 GitHub！`);
                            fetchPDFFiles(); // 刷新 PDF 檔案列表
                        } else {
                            console.log(`PDF 上傳至 GitHub 失敗: ${uploadPath}`);
                            alert(`報價單編號 ${orderNumber} 已完成，但上傳至 GitHub 失敗，請檢查 PAT 或網路！`);
                        }

                        resetForm();
                        await updateQuotePreview();
                    } catch (error) {
                        console.error('PDF 生成錯誤:', error);
                        throw new Error(`PDF 生成失敗：${error.message}`);
                    } finally {
                        if (document.body.contains(clone)) {
                            document.body.removeChild(clone);
                        }
                    }
                } catch (error) {
                    console.error('產生報價單錯誤:', error);
                    alert(`產生報價單失敗：${error.message}`);
                } finally {
                    generateQuoteBtn.disabled = false;
                }
            });
        });
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9336e73aed49bd41',t:'MTc0NTE3NTgyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9337c0e95c19add2',t:'MTc0NTE4NDczOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){